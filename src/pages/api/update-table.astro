---
import pool from '../../db.js';

export const prerender = false;

if (Astro.request.method === 'POST') {
  try {
    console.log('Intentando conectar a la base de datos...');
    const client = await pool.connect();
    try {
      console.log('Conexión exitosa. Ejecutando consulta...');
      await client.query(`
        ALTER TABLE survey_responses
        ADD COLUMN IF NOT EXISTS conoce_marca VARCHAR(3),
        ADD COLUMN IF NOT EXISTS ha_probado VARCHAR(3),
        ADD COLUMN IF NOT EXISTS imagen VARCHAR(3),
        ADD COLUMN IF NOT EXISTS compra VARCHAR(3),
        ADD COLUMN IF NOT EXISTS precio DECIMAL(10, 2),
        ADD COLUMN IF NOT EXISTS sabor VARCHAR(50),
        ADD COLUMN IF NOT EXISTS tiendas TEXT[]
      `);
      console.log('Consulta ejecutada exitosamente');
      return new Response(JSON.stringify({ message: 'Tabla actualizada exitosamente' }), {
        status: 200,
        headers: {
          'Content-Type': 'application/json'
        }
      });
    } finally {
      client.release();
    }
  } catch (err) {
    console.error('Error detallado:', err);
    return new Response(JSON.stringify({ 
      error: 'Error al actualizar la tabla', 
      details: err.message,
      stack: err.stack
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json'
      }
    });
  }
}

return new Response(JSON.stringify({ error: 'Método no permitido' }), {
  status: 405,
  headers: {
    'Content-Type': 'application/json'
  }
});
---